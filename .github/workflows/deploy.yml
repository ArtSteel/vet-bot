name: Deploy Vet-bot to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VET_BOT_HOST }}
          username: ${{ secrets.VET_BOT_USER }}
          key: ${{ secrets.VET_BOT_SSH_KEY }}
          port: ${{ secrets.VET_BOT_SSH_PORT || 22 }}
          script: |
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π vet-bot..."
            
            cd /opt/vet-bot || { echo "‚ùå –ü–∞–ø–∫–∞ /opt/vet-bot –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; exit 1; }
            
            echo "üì• –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥ –∏–∑ GitHub..."
            git pull origin main || { echo "‚ùå –û—à–∏–±–∫–∞ git pull"; exit 1; }
            
            echo "üì¶ –û–±–Ω–æ–≤–ª—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            source .venv/bin/activate
            pip install -r requirements.txt --quiet --upgrade || { echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"; exit 1; }
            
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å vetbot..."
            sudo systemctl restart vetbot || { echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞"; exit 1; }
            
            sleep 3
            
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞..."
            if sudo systemctl is-active --quiet vetbot; then
              echo "‚úÖ –°–µ—Ä–≤–∏—Å vetbot —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
              sudo systemctl status vetbot --no-pager -n 30
            else
              echo "‚ùå –°–µ—Ä–≤–∏—Å vetbot –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
              sudo systemctl status vetbot --no-pager -n 100
              exit 1
            fi
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
