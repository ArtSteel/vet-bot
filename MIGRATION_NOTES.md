# –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Async Storage (SQLAlchemy 2.0)

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –î–æ–±–∞–≤–ª–µ–Ω—ã: `sqlalchemy>=2.0.0,<3.0.0` –∏ `aiosqlite>=0.19.0`
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞: `pip install -r requirements.txt`

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞
- **`models.py`** ‚Äî ORM –º–æ–¥–µ–ª–∏ (User, Pet, History, YooKassaPayment, Feedback)
- **`storage.py`** ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ async SQLAlchemy 2.0
- –í—Å–µ –º–µ—Ç–æ–¥—ã —Ç–µ–ø–µ—Ä—å `async def` –∏ —Ç—Ä–µ–±—É—é—Ç `await`

### 3. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü **–Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å** ‚Äî —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `bot.db` —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏
- SQLAlchemy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
- –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é

### 4. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

**–ë—ã–ª–æ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ):**
```python
pet = st.get_active_pet(user_id)
st.save_entry(user_id, text, reply)
```

**–°—Ç–∞–ª–æ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ):**
```python
pet = await st.get_active_pet(user_id)
entry_id = await st.save_entry(user_id, text, reply)
```

### 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î

**–ë—ã–ª–æ:**
```python
st.init_db()  # —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
```

**–°—Ç–∞–ª–æ:**
```python
await st.init_db()  # –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
```

### 6. –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ PostgreSQL

–ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω —Å —É—á—ë—Ç–æ–º –±—É–¥—É—â–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ PostgreSQL:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π SQLAlchemy —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (–±–µ–∑ SQLite-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∏)
- –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ PostgreSQL –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å `DATABASE_URL` –≤ `storage.py`:
  ```python
  DATABASE_URL = "postgresql+asyncpg://user:pass@localhost/dbname"
  ```
- –ò –¥–æ–±–∞–≤–∏—Ç—å `asyncpg` –≤ `requirements.txt`

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

1. –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `pip install -r requirements.txt`
2. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞: `python bot.py`
3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `üìÇ –ë–î –≥–æ—Ç–æ–≤–∞ (Async SQLAlchemy 2.0)`
4. –ü—Ä–æ–≤–µ—Ä—å —Ä–∞–±–æ—Ç—É –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
   - `/start` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `/medcard` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ/–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–∏—Ç–æ–º—Ü–∞
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
   - `/stats` (–∞–¥–º–∏–Ω) ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç Event Loop** ‚Äî –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ë–î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –≥–æ—Ç–æ–≤–æ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ PostgreSQL
- ‚úÖ **–¢–∏–ø–∏–∑–∞—Ü–∏—è** ‚Äî –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ type hints
- ‚úÖ **ORM –≤–º–µ—Å—Ç–æ —Å—ã—Ä–æ–≥–æ SQL** ‚Äî –ø—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å
- ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Äî —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ë–î —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
